name: Export Secret to Target Repo

# Triggered by repository_dispatch from check-and-sync-secrets.sh in requesting repos
# Reads secret from mosuon-devops-k8s repo and sets it in the target repo
on:
  repository_dispatch:
    types: [export-secret]

jobs:
  export:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Validate payload
        id: validate
        run: |
          SECRET_NAME="${{ github.event.client_payload.secret_name }}"
          TARGET_REPO="${{ github.event.client_payload.target_repo }}"
          
          if [ -z "$SECRET_NAME" ] || [ -z "$TARGET_REPO" ]; then
            echo "[ERROR] Missing secret_name or target_repo in payload"
            exit 1
          fi
          
          echo "SECRET_NAME=$SECRET_NAME" >> $GITHUB_OUTPUT
          echo "TARGET_REPO=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "[INFO] Exporting secret '$SECRET_NAME' to repo '$TARGET_REPO'"

      - name: Export secret to target repo
        env:
          SECRET_NAME: ${{ steps.validate.outputs.SECRET_NAME }}
          TARGET_REPO: ${{ steps.validate.outputs.TARGET_REPO }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Verify target repo format (owner/repo)
          if ! [[ "$TARGET_REPO" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$ ]]; then
            echo "[ERROR] Invalid target repo format: $TARGET_REPO (expected: owner/repo)"
            exit 1
          fi
          
          # Read secret from current repo (mosuon-devops-k8s) - requires proper auth
          SECRET_VALUE=$(gh secret view "$SECRET_NAME" || true)
          
          if [ -z "$SECRET_VALUE" ]; then
            echo "[ERROR] Secret '$SECRET_NAME' not found in mosuon-devops-k8s"
            exit 1
          fi
          
          # Mask secret in logs
          echo "::add-mask::$SECRET_VALUE"
          
          # Set secret in target repo
          echo "Setting $SECRET_NAME in $TARGET_REPO..."
          gh secret set "$SECRET_NAME" \
            -b "$SECRET_VALUE" \
            --repo "$TARGET_REPO" || {
            echo "[ERROR] Failed to set secret in target repo"
            exit 1
          }
          
          echo "[INFO] Successfully exported $SECRET_NAME to $TARGET_REPO"
