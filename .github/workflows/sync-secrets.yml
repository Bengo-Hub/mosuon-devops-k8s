name: Sync Secrets (Mosuon Cluster)

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (e.g., Bengo-Hub/game-stats-api)'
        required: true
        type: string
      secrets:
        description: 'Space-separated secret names to sync'
        required: true
        type: string

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          echo "Target: ${{ inputs.target_repo }}"
          echo "Secrets: ${{ inputs.secrets }}"
          
      - name: Sync secrets
        env:
          # Use GH_PAT if available, fallback to GIT_TOKEN or GITHUB_TOKEN
          # Note: Requires a PAT with repo and workflow permissions
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GIT_TOKEN || github.token }}
          TARGET_REPO: ${{ inputs.target_repo }}
          # Map actual secret names - now inheriting from Bengo-Hub org-level secrets
          # NOTE: Most deployment secrets inherit from org-level (set months ago, correct values)
          # Base64-encoded secrets (3)
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DOCKER_SSH_KEY: ${{ secrets.DOCKER_SSH_KEY }}
          # Docker Registry secrets (3)
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          REGISTRY_EMAIL: ${{ secrets.REGISTRY_EMAIL }}
          # GitHub/Git secrets
          GIT_TOKEN: ${{ secrets.GH_PAT || secrets.GIT_TOKEN || github.token }}
          GH_PAT: ${{ secrets.GH_PAT || secrets.GIT_TOKEN || github.token }}
          # Database passwords (3)
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          # SSH/VPS credentials
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          # Mosuon-specific VPS credentials (if different from main SSH)
          VPS_SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
          VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}
          VPS_SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
          VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}
        run: |
          set -uo pipefail  # Removed -e for better error handling
          
          echo "======================================"
          echo "üîç DIAGNOSTIC: Pre-flight Checks"
          echo "======================================"
          
          # Validate GH_TOKEN
          if [ -z "$GH_TOKEN" ]; then
            echo "‚ùå FATAL: GH_TOKEN is empty or not set"
            echo "DEBUG: Cannot authenticate gh CLI without token"
            exit 1
          fi
          echo "‚úÖ GH_TOKEN is set (length: ${#GH_TOKEN} chars)"
          
          # Validate TARGET_REPO
          if [ -z "$TARGET_REPO" ]; then
            echo "‚ùå FATAL: TARGET_REPO is empty"
            exit 1
          fi
          echo "‚úÖ TARGET_REPO is set: $TARGET_REPO"
          
          # Verify gh CLI can authenticate with GH_TOKEN from environment
          # Note: gh CLI automatically uses GH_TOKEN env var - no need for 'gh auth login'
          echo ""
          echo "üîê Verifying gh CLI authentication..."
          if gh auth status 2>&1 | grep -q "Logged in"; then
            echo "‚úÖ gh CLI authenticated via GH_TOKEN environment variable"
          else
            echo "‚ö†Ô∏è  Warning: gh auth status check inconclusive, but GH_TOKEN is set - attempting to continue..."
            echo "   gh will use GH_TOKEN from environment automatically"
          fi
          
          # Parse requested secrets
          echo ""
          echo "======================================"
          echo "üì¶ Processing Requested Secrets"
          echo "======================================"
          IFS=' ' read -ra SECRETS_ARRAY <<< "${{ inputs.secrets }}"
          echo "Requested secrets (${#SECRETS_ARRAY[@]} total):"
          for s in "${SECRETS_ARRAY[@]}"; do
            echo "  - $s"
          done
          
          echo ""
          echo "======================================"
          echo "üîÑ Syncing Secrets"
          echo "======================================"
          echo "‚ö†Ô∏è  NOTE: Secrets are synced AS-IS without transformation"
          echo "   - Encoded secrets (KUBE_CONFIG, SSH keys) remain encoded"
          echo "   - Plaintext secrets (passwords, usernames) remain plaintext"
          echo ""
          
          SUCCESS=0
          WARNED=0
          FAILED=0
          WARNED_SECRETS=()
          FAILED_SECRETS=()
          
          for SECRET_NAME in "${SECRETS_ARRAY[@]}"; do
            echo ""
            echo "--- Processing: $SECRET_NAME ---"
            
            # Get value from environment variable
            SECRET_VALUE="${!SECRET_NAME:-}"
            
            # Debug: Show if value exists and its length (not the actual value)
            if [ -z "$SECRET_VALUE" ]; then
              echo "‚ö†Ô∏è  WARNING: $SECRET_NAME not found in mosuon-devops-k8s secrets"
              echo "   This secret may not be set yet in the mosuon-devops-k8s repository"
              echo "   Skipping this secret - set it in mosuon-devops-k8s first if needed"
              echo "   Command: gh secret set $SECRET_NAME --repo Bengo-Hub/mosuon-devops-k8s"
              WARNED=$((WARNED + 1))
              WARNED_SECRETS+=("$SECRET_NAME (not set in mosuon-devops-k8s)")
              continue
            fi
            
            # Show value info without exposing it
            VALUE_LEN=${#SECRET_VALUE}
            if [ $VALUE_LEN -lt 10 ]; then
              VALUE_PREVIEW="${SECRET_VALUE:0:2}***"
            else
              VALUE_PREVIEW="${SECRET_VALUE:0:4}...***"
            fi
            echo "‚úÖ Value found (length: $VALUE_LEN chars, preview: $VALUE_PREVIEW)"
            
            # Set secret in target repo
            # CRITICAL: Use --body with the value directly. Do NOT use --body - (sets literal '-')
            # gh secret set reads from stdin ONLY when --body is NOT specified
            echo "üîÑ Setting $SECRET_NAME in $TARGET_REPO..."
            
            # Capture both stdout and stderr
            SYNC_OUTPUT=$(mktemp)
            SYNC_ERROR=$(mktemp)
            
            if printf '%s' "$SECRET_VALUE" | gh secret set "$SECRET_NAME" \
              --repo "$TARGET_REPO" >"$SYNC_OUTPUT" 2>"$SYNC_ERROR"; then
              
              echo "‚úÖ SUCCESS: $SECRET_NAME synced ($VALUE_LEN chars)"
              
              # Show gh output if any
              if [ -s "$SYNC_OUTPUT" ]; then
                echo "   gh output: $(cat "$SYNC_OUTPUT")"
              fi
              
              SUCCESS=$((SUCCESS + 1))
            else
              EXIT_CODE=$?
              echo "‚ùå FAILED: Could not sync $SECRET_NAME"
              echo "   Exit code: $EXIT_CODE"
              
              # Show detailed error
              if [ -s "$SYNC_ERROR" ]; then
                echo "   Error output:"
                cat "$SYNC_ERROR" | sed 's/^/   | /'
              fi
              if [ -s "$SYNC_OUTPUT" ]; then
                echo "   Standard output:"
                cat "$SYNC_OUTPUT" | sed 's/^/   | /'
              fi
              
              FAILED=$((FAILED + 1))
              FAILED_SECRETS+=("$SECRET_NAME (gh secret set failed with code $EXIT_CODE)")
            fi
            
            # Cleanup temp files
            rm -f "$SYNC_OUTPUT" "$SYNC_ERROR"
          done
          
          echo ""
          echo "======================================"
          echo "üìä FINAL SUMMARY"
          echo "======================================"
          echo "Target Repository: $TARGET_REPO"
          echo "Requested Secrets: ${#SECRETS_ARRAY[@]}"
          echo "‚úÖ Successfully Synced: $SUCCESS"
          echo "‚ö†Ô∏è  Warnings (not in mosuon-devops-k8s): $WARNED"
          echo "‚ùå Failed: $FAILED"
          
          if [ ${#WARNED_SECRETS[@]} -gt 0 ]; then
            echo ""
            echo "Warned secrets (not set in mosuon-devops-k8s):"
            for warned in "${WARNED_SECRETS[@]}"; do
              echo "  ‚ö†Ô∏è  $warned"
            done
            echo ""
            echo "üí° Tip: Set missing secrets in mosuon-devops-k8s, then re-run this workflow"
          fi
          
          if [ ${#FAILED_SECRETS[@]} -gt 0 ]; then
            echo ""
            echo "Failed secrets (gh secret set error):"
            for failed in "${FAILED_SECRETS[@]}"; do
              echo "  ‚ùå $failed"
            done
          fi
          
          echo "======================================"
          
          if [ $FAILED -gt 0 ]; then
            echo ""
            echo "‚ùå WORKFLOW FAILED: $FAILED secret(s) could not be synced"
            echo "   (Warnings and skips are OK - only actual sync errors cause failure)"
            exit 1
          else
            echo ""
            if [ $SUCCESS -gt 0 ]; then
              echo "‚úÖ WORKFLOW SUCCESS: $SUCCESS secret(s) synced successfully!"
            else
              echo "‚úÖ WORKFLOW COMPLETE: No secrets synced (all skipped or warned)"
            fi
            exit 0
          fi
