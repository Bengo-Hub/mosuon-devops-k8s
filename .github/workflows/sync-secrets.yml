name: Sync Secrets (Mosuon Cluster)

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (e.g., Bengo-Hub/game-stats-api)'
        required: true
        type: string
      secrets:
        description: 'Space-separated secret names to sync'
        required: true
        type: string

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          echo "Target: ${{ inputs.target_repo }}"
          echo "Secrets: ${{ inputs.secrets }}"
          
      - name: Sync secrets
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          TARGET_REPO: ${{ inputs.target_repo }}
          # Map actual secret names from mosuon-devops-k8s
          # Base64-encoded secrets (3)
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DOCKER_SSH_KEY: ${{ secrets.DOCKER_SSH_KEY }}
          # Docker Registry secrets (3)
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          REGISTRY_EMAIL: ${{ secrets.REGISTRY_EMAIL }}
          # GitHub/Git secrets (use GH_PAT for both)
          GIT_TOKEN: ${{ secrets.GH_PAT }}
          GH_PAT: ${{ secrets.GH_PAT }}
          # Database passwords (3)
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          # SSH/VPS credentials (use whatever exists in mosuon repo)
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          VPS_SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
          VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}
        run: |
          set -uo pipefail  # Removed -e for better error handling
          
          echo "======================================"
          echo "üîç DIAGNOSTIC: Pre-flight Checks"
          echo "======================================"
          
          # Validate GH_TOKEN
          if [ -z "$GH_TOKEN" ]; then
            echo "‚ùå FATAL: GH_TOKEN is empty or not set"
            echo "DEBUG: Cannot authenticate gh CLI without token"
            exit 1
          fi
          echo "‚úÖ GH_TOKEN is set (length: ${#GH_TOKEN} chars)"
          
          # Validate TARGET_REPO
          if [ -z "$TARGET_REPO" ]; then
            echo "‚ùå FATAL: TARGET_REPO is empty"
            exit 1
          fi
          echo "‚úÖ TARGET_REPO is set: $TARGET_REPO"
          
          # Authenticate gh CLI
          echo ""
          echo "üîê Authenticating gh CLI..."
          if echo "$GH_TOKEN" | gh auth login --with-token 2>&1; then
            echo "‚úÖ gh CLI authenticated successfully"
          else
            echo "‚ùå FATAL: Failed to authenticate gh CLI"
            exit 1
          fi
          
          # Verify gh auth status
          echo ""
          echo "üìã Verifying gh auth status..."
          if gh auth status 2>&1; then
            echo "‚úÖ gh auth verified"
          else
            echo "‚ö†Ô∏è  Warning: gh auth status check failed but continuing..."
          fi
          
          # Parse requested secrets
          echo ""
          echo "======================================"
          echo "üì¶ Processing Requested Secrets"
          echo "======================================"
          IFS=' ' read -ra SECRETS_ARRAY <<< "${{ inputs.secrets }}"
          echo "Requested secrets (${#SECRETS_ARRAY[@]} total):"
          for s in "${SECRETS_ARRAY[@]}"; do
            echo "  - $s"
          done
          
          echo ""
          echo "======================================"
          echo "üîÑ Syncing Secrets"
          echo "======================================"
          
          SUCCESS=0
          FAILED=0
          FAILED_SECRETS=()
          
          for SECRET_NAME in "${SECRETS_ARRAY[@]}"; do
            echo ""
            echo "--- Processing: $SECRET_NAME ---"
            
            # Get value from environment variable
            SECRET_VALUE="${!SECRET_NAME:-}"
            
            # Debug: Show if value exists and its length (not the actual value)
            if [ -z "$SECRET_VALUE" ]; then
              echo "‚ùå ERROR: $SECRET_NAME not found in workflow environment"
              echo "   This means either:"
              echo "   1. The secret doesn't exist in mosuon-devops-k8s repo"
              echo "   2. The secret name in env: mapping is incorrect"
              echo "   3. The secret value is literally empty"
              FAILED=$((FAILED + 1))
              FAILED_SECRETS+=("$SECRET_NAME (not found in env)")
              continue
            fi
            
            # Show value info without exposing it
            VALUE_LEN=${#SECRET_VALUE}
            if [ $VALUE_LEN -lt 10 ]; then
              VALUE_PREVIEW="${SECRET_VALUE:0:2}***"
            else
              VALUE_PREVIEW="${SECRET_VALUE:0:4}...***"
            fi
            echo "‚úÖ Value found (length: $VALUE_LEN chars, preview: $VALUE_PREVIEW)"
            
            # Set secret in target repo
            echo "üîÑ Setting $SECRET_NAME in $TARGET_REPO..."
            
            # Capture both stdout and stderr
            SYNC_OUTPUT=$(mktemp)
            SYNC_ERROR=$(mktemp)
            
            if echo -n "$SECRET_VALUE" | gh secret set "$SECRET_NAME" \
              --repo "$TARGET_REPO" \
              --body - >"$SYNC_OUTPUT" 2>"$SYNC_ERROR"; then
              
              echo "‚úÖ SUCCESS: $SECRET_NAME synced successfully"
              
              # Show gh output if any
              if [ -s "$SYNC_OUTPUT" ]; then
                echo "   gh output: $(cat "$SYNC_OUTPUT")"
              fi
              
              SUCCESS=$((SUCCESS + 1))
            else
              EXIT_CODE=$?
              echo "‚ùå FAILED: Could not sync $SECRET_NAME"
              echo "   Exit code: $EXIT_CODE"
              
              # Show detailed error
              if [ -s "$SYNC_ERROR" ]; then
                echo "   Error output:"
                cat "$SYNC_ERROR" | sed 's/^/   | /'
              fi
              if [ -s "$SYNC_OUTPUT" ]; then
                echo "   Standard output:"
                cat "$SYNC_OUTPUT" | sed 's/^/   | /'
              fi
              
              FAILED=$((FAILED + 1))
              FAILED_SECRETS+=("$SECRET_NAME (gh secret set failed with code $EXIT_CODE)")
            fi
            
            # Cleanup temp files
            rm -f "$SYNC_OUTPUT" "$SYNC_ERROR"
          done
          
          echo ""
          echo "======================================"
          echo "üìä FINAL SUMMARY"
          echo "======================================"
          echo "Target Repository: $TARGET_REPO"
          echo "Requested Secrets: ${#SECRETS_ARRAY[@]}"
          echo "‚úÖ Successfully Synced: $SUCCESS"
          echo "‚ùå Failed: $FAILED"
          
          if [ ${#FAILED_SECRETS[@]} -gt 0 ]; then
            echo ""
            echo "Failed secrets:"
            for failed in "${FAILED_SECRETS[@]}"; do
              echo "  ‚ùå $failed"
            done
          fi
          
          echo "======================================"
          
          if [ $FAILED -gt 0 ]; then
            echo ""
            echo "‚ùå WORKFLOW FAILED: $FAILED secret(s) could not be synced"
            exit 1
          else
            echo ""
            echo "‚úÖ WORKFLOW SUCCESS: All secrets synced successfully!"
            exit 0
          fi
