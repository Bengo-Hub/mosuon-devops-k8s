name: Sync Secrets (Mosuon Cluster)

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (e.g., Bengo-Hub/game-stats-api)'
        required: true
        type: string
      secrets:
        description: 'Space-separated secret names to sync'
        required: true
        type: string

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          echo "Target: ${{ inputs.target_repo }}"
          echo "Secrets: ${{ inputs.secrets }}"
          
      - name: Sync secrets
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          TARGET_REPO: ${{ inputs.target_repo }}
          # Map all secrets for mosuon cluster
          # Base64-encoded secrets (3)
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DOCKER_SSH_KEY: ${{ secrets.DOCKER_SSH_KEY }}
          # Docker Registry secrets (4)
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          REGISTRY_EMAIL: ${{ secrets.REGISTRY_EMAIL }}
          REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
          # GitHub/Git secrets (2)
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
          GH_PAT: ${{ secrets.GH_PAT }}
          # Database passwords (4)
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          # VPS credentials (3)
          VPS_SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
          VPS_SSH_USER: ${{ secrets.VPS_SSH_USER }}
          VPS_SSH_PASSWORD: ${{ secrets.VPS_SSH_PASSWORD }}
          # M-Pesa/Payment credentials (4)
          MPESA_CONSUMER_KEY: ${{ secrets.MPESA_CONSUMER_KEY }}
          MPESA_CONSUMER_SECRET: ${{ secrets.MPESA_CONSUMER_SECRET }}
          MPESA_SHORTCODE: ${{ secrets.MPESA_SHORTCODE }}
          MPESA_PASSKEY: ${{ secrets.MPESA_PASSKEY }}
          # Email/SMTP (3)
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          # JWT/Auth (2)
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        run: |
          set -e
          
          # Authenticate gh CLI
          echo "$GH_TOKEN" | gh auth login --with-token
          
          # Parse requested secrets
          IFS=' ' read -ra SECRETS_ARRAY <<< "${{ inputs.secrets }}"
          
          SUCCESS=0
          FAILED=0
          
          for SECRET_NAME in "${SECRETS_ARRAY[@]}"; do
            # Get value from environment variable
            SECRET_VALUE="${!SECRET_NAME}"
            
            if [ -z "$SECRET_VALUE" ]; then
              echo "❌ $SECRET_NAME not found in mosuon-devops-k8s secrets"
              FAILED=$((FAILED + 1))
              continue
            fi
            
            # Set secret in target repo  
            echo "Syncing $SECRET_NAME to $TARGET_REPO..."
            if echo -n "$SECRET_VALUE" | gh secret set "$SECRET_NAME" \
              --repo "$TARGET_REPO" \
              --body - 2>&1; then
              echo "✅ $SECRET_NAME synced successfully"
              SUCCESS=$((SUCCESS + 1))
            else
              echo "❌ Failed to sync $SECRET_NAME"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo ""
          echo "=== Summary ==="
          echo "✅ Success: $SUCCESS"
          echo "❌ Failed: $FAILED"
          
          if [ $FAILED -gt 0 ]; then
            exit 1
          fi
