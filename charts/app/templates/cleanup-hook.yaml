{{- if .Values.cleanup }}
{{- if .Values.cleanup.enabled }}
{{- if eq .Values.cleanup.enabled true }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app.fullname" . }}-cleanup-script
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
data:
  cleanup.sh: |
    #!/bin/bash
    set -euo pipefail
    
    echo "ðŸ§¹ Running pre-deploy cleanup for {{ include "app.fullname" . }}..."
    
    # Call centralized cleanup script for this specific app
    # Download and execute from cluster (assumes cleanup script is in a known location)
    NAMESPACE="{{ .Release.Namespace }}"
    APP_NAME="{{ include "app.fullname" . }}"
    
    # Inline minimal cleanup (centralized script handles cluster-wide cleanup)
    # This hook only cleans up pods for THIS specific app to avoid permission issues
    
    echo "ðŸ” Cleaning up failed/error pods for app=$APP_NAME in namespace=$NAMESPACE..."
    
    # Delete failed/unknown pods
    kubectl delete pods -n "$NAMESPACE" -l "app=$APP_NAME" \
      --field-selector="status.phase=Failed" \
      --grace-period=0 --force 2>/dev/null || true
    
    kubectl delete pods -n "$NAMESPACE" -l "app=$APP_NAME" \
      --field-selector="status.phase=Unknown" \
      --grace-period=0 --force 2>/dev/null || true
    
    # Delete image pull error pods
    for REASON in ImagePullBackOff ErrImagePull; do
      PODS=$(kubectl get pods -n "$NAMESPACE" -l "app=$APP_NAME" \
        -o jsonpath="{.items[?(@.status.containerStatuses[*].state.waiting.reason==\"$REASON\")].metadata.name}" 2>/dev/null || echo "")
      [ -n "$PODS" ] && kubectl delete pod -n "$NAMESPACE" $PODS --grace-period=0 --force 2>/dev/null || true
    done
    
    # Delete old replicaset pods
    OLD_RS=$(kubectl get rs -n "$NAMESPACE" -l "app=$APP_NAME" --sort-by=.metadata.creationTimestamp \
      -o jsonpath='{.items[:-1].metadata.name}' 2>/dev/null || echo "")
    
    for RS in $OLD_RS; do
      PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath="{.items[?(@.metadata.ownerReferences[0].name==\"$RS\")].metadata.name}" 2>/dev/null || echo "")
      [ -n "$PODS" ] && kubectl delete pod -n "$NAMESPACE" $PODS --grace-period=0 --force 2>/dev/null || true
    done
    
    echo "âœ… Cleanup complete for {{ include "app.fullname" . }}"
    
    TOTAL_PODS=$(kubectl get pods --all-namespaces --no-headers 2>/dev/null | wc -l)
    echo "  ðŸ“Š Total cluster pods: $TOTAL_PODS"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "app.fullname" . }}-pre-deploy-cleanup-{{ .Release.Revision }}
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
  annotations:
    # Run before helm install/upgrade
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300 # Delete job after 5 minutes
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: {{ include "app.fullname" . }}-cleanup
    spec:
      serviceAccountName: {{ include "app.fullname" . }}-cleanup
      restartPolicy: OnFailure
      containers:
        - name: cleanup
          image: bitnami/kubectl:1.29
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash", "/scripts/cleanup.sh"]
          volumeMounts:
            - name: cleanup-script
              mountPath: /scripts
      volumes:
        - name: cleanup-script
          configMap:
            name: {{ include "app.fullname" . }}-cleanup-script
            defaultMode: 0755
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "app.fullname" . }}-cleanup
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-15"
    helm.sh/hook-delete-policy: before-hook-creation
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "app.fullname" . }}-cleanup
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-15"
    helm.sh/hook-delete-policy: before-hook-creation
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "delete"]
  - apiGroups: ["apps"]
    resources: ["replicasets"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "app.fullname" . }}-cleanup
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-15"
    helm.sh/hook-delete-policy: before-hook-creation
subjects:
  - kind: ServiceAccount
    name: {{ include "app.fullname" . }}-cleanup
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: {{ include "app.fullname" . }}-cleanup
  apiGroup: rbac.authorization.k8s.io
{{- end }}
{{- end }}
{{- end }}
