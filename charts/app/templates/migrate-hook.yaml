{{- if and .Values.migrations .Values.migrations.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "app.fullname" . }}-migrate-{{ .Values.image.tag | trunc 8 }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "app.fullname" . }}
    component: migration
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: {{ include "app.fullname" . }}
        component: migration
    spec:
      restartPolicy: Never
      {{- if .Values.securityContext }}
      securityContext:
        {{- if .Values.securityContext.fsGroup }}
        fsGroup: {{ .Values.securityContext.fsGroup }}
        {{- end }}
      {{- end }}
      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.image.pullSecrets | nindent 8 }}
      {{- end }}
      {{- if .Values.volumes }}
      volumes:
        {{- toYaml .Values.volumes | nindent 8 }}
      {{- end }}
      containers:
      - name: migrate
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
        {{- if .Values.volumeMounts }}
        volumeMounts:
          {{- toYaml .Values.volumeMounts | nindent 10 }}
        {{- end }}
        {{- if .Values.envFromSecret }}
        envFrom:
        - secretRef:
            name: {{ .Values.envFromSecret }}
        {{- end }}
        {{- if .Values.env }}
        env:
          {{- toYaml .Values.env | nindent 10 }}
        {{- end }}
        resources:
          requests:
            memory: {{ .Values.migrations.resources.requests.memory | default "512Mi" }}
            cpu: {{ .Values.migrations.resources.requests.cpu | default "250m" }}
          limits:
            memory: {{ .Values.migrations.resources.limits.memory | default "2Gi" }}
            cpu: {{ .Values.migrations.resources.limits.cpu | default "1000m" }}
        command:
        - sh
        - -c
        - |
          set -e

          echo "=========================================="
          echo "Database Migrations - Helm Hook"
          echo "=========================================="
          echo "Namespace: {{ .Release.Namespace }}"
          echo "Release: {{ .Release.Name }}"
          echo "Image: {{ .Values.image.repository }}:{{ .Values.image.tag }}"
          echo "Pod: $HOSTNAME"
          echo ""

          # Detect framework and run appropriate migrations
          if [ -f "/app/manage.py" ]; then
            # Django application
            echo "Detected Django application"

            # Wait for database using Django's built-in check
            echo "Waiting for database connection..."
            MAX_RETRIES=60
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if python manage.py check --database default > /dev/null 2>&1; then
                echo "Database connection successful"
                break
              fi

              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $((RETRY_COUNT % 10)) -eq 0 ]; then
                echo "  Still waiting... (attempt $RETRY_COUNT/$MAX_RETRIES)"
              fi
              sleep 2
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "Failed to connect to database after $MAX_RETRIES attempts"
              exit 1
            fi

            echo ""
            echo "Running Django migrations..."
            python manage.py migrate --fake-initial --noinput
            echo "Django migrations completed"

          elif [ -x "/usr/local/bin/{{ .Values.migrations.binaryName | default (printf "%s-migrate" (include "app.name" .)) }}" ] || [ -x "/app/migrate" ]; then
            # Go application with Ent
            echo "Detected Go application (Ent ORM)"

            # Try common migrate binary locations
            if [ -x "/usr/local/bin/{{ .Values.migrations.binaryName | default (printf "%s-migrate" (include "app.name" .)) }}" ]; then
              echo "Running migrate binary: /usr/local/bin/{{ .Values.migrations.binaryName | default (printf "%s-migrate" (include "app.name" .)) }}"
              /usr/local/bin/{{ .Values.migrations.binaryName | default (printf "%s-migrate" (include "app.name" .)) }}
            elif [ -x "/app/migrate" ]; then
              echo "Running migrate binary: /app/migrate"
              /app/migrate
            else
              echo "Migrate binary not found"
              exit 1
            fi

            echo "Ent migrations completed"

          elif [ -f "/app/artisan" ]; then
            # Laravel application
            echo "Detected Laravel application"

            echo "Running Laravel migrations..."
            php artisan migrate --force
            echo "Laravel migrations completed"

          else
            echo "No recognized framework detected"
            echo "Searched for: Django (manage.py), Go/Ent (migrate binary), Laravel (artisan)"
            exit 1
          fi

          echo ""
          echo "=========================================="
          echo "Migration Job Complete"
          echo "=========================================="
{{- end }}

